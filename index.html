<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>í’€ë°”ìœ„ ì‚¬ì£¼ ê³„ì‚°ê¸° v5.0 â€” GPT ì—°ë™ ë²„ì „</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@500;600&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root{
  --wood:#228b22; --fire:#d03333; --earth:#d4a017; --metal:#bfbfbf; --water:#1e40af;
  --fg:#000; --bg:#fff; --line:#e6e6e6;
  --hanja-font:"Noto Serif JP",serif; --hanja-weight:600; --hanja-track:.01em;
  --tileW:92px; --gap:10px; --rail-pad:16px;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);
  font-family:"Noto Sans KR",system-ui,Apple SD Gothic Neo,Malgun Gothic,sans-serif}

/* ê³µí†µ UI */
.btn{border:0;border-radius:10px;padding:10px 18px;cursor:pointer;font-size:16px}
.btn-dark{background:#000;color:#fff}
.btn-ghost{background:#f4f5f7;color:#111}
.sectionTitle{margin:28px 0 8px;text-align:center;font-weight:900}
.g-sip{font-size:13px;color:#666;text-align:center}

/* í˜ì´ì§€ */
#app{max-width:1100px;margin:0 auto;padding:28px 16px 64px}
h1{margin:0 0 8px;text-align:center}
.sub{margin:0 0 20px;text-align:center;color:#666}
.form{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;max-width:720px;margin:0 auto}
label{font-size:14px;color:#444;display:block;margin-bottom:6px;text-align:center}
input{padding:12px;border:1px solid #ccc;border-radius:10px;font-size:18px;text-align:center;width:100%}
.genderBox{display:flex;justify-content:center;gap:18px;margin:14px 0}
.genderBox label{font-size:16px;color:#222}
.topbar{display:flex;justify-content:center;gap:8px;margin:6px 0 20px}

/* ì›êµ­ */
.pillars{display:flex;flex-direction:row-reverse;gap:14px;justify-content:center;margin-top:14px}
.pillar{border:1px solid var(--line);border-radius:12px;background:#fff;width:170px;padding:10px;text-align:center}
.pillar h3{margin:0 0 8px;background:#f2f2f2;border-radius:8px;padding:6px 0;font-size:14px;color:#444}
.gz{display:grid;grid-template-rows:auto auto auto auto;gap:6px}

/* í•œì */
.g-big{
  font-family:var(--hanja-font);font-weight:var(--hanja-weight);letter-spacing:var(--hanja-track);
  font-size:28px;border-radius:10px;padding:8px 0;color:#fff !important;
  position:relative;box-shadow:0 1px 0 rgba(0,0,0,.06) inset;
}
.g-big .gbtxt{display:inline-block;line-height:1;transform:translateY(-1.6px);}

/* ì˜¤í–‰ìƒ‰ */
.g-big.wood{background:var(--wood)}
.g-big.fire{background:var(--fire)}
.g-big.earth{background:var(--earth)}
.g-big.metal{background:var(--metal)}
.g-big.water{background:var(--water)}

/* ë ˆì¼ */
.railWrap{
  width:min(100%,calc(var(--tileW)*4 + var(--gap)*3 + var(--rail-pad)));
  margin:0 auto;overflow-x:auto;overflow-y:hidden;
  -webkit-overflow-scrolling:touch;padding-bottom:6px;
}
.rail{
  display:inline-flex;
  flex-direction:row-reverse;
  gap:var(--gap); padding:6px 8px 10px;
  flex-wrap:nowrap; justify-content:flex-start;
  scroll-snap-type:x proximity;
}
.tile{
  min-width:var(--tileW);border:1px solid var(--line);border-radius:12px;
  background:#fff;padding:6px;text-align:center;cursor:pointer;
  transition:.15s;flex:0 0 auto;scroll-snap-align:center;
}
.tile.active{border:2px solid #000}

/* GPT ì „ìš© ì›êµ­ í…ìŠ¤íŠ¸ ì˜ì—­ */
#pulbawi-gpt-output{
  margin-top:20px;
  padding:12px 16px;
  border:1px solid #ddd;
  border-radius:10px;
  background:#fafafa;
}
#gpt-year, #gpt-month, #gpt-day{
  margin:4px 0;
  font-size:17px;
  font-weight:600;
}

</style>
</head>
<body>

<section id="app">
  <h1>í’€ë°”ìœ„ ì‚¬ì£¼ ê³„ì‚°ê¸°</h1>
  <p class="sub">ì–‘ë ¥ ê¸°ì¤€ Â· ìì‹œê²½ê³„(23:30~01:29) Â· í•œêµ­ì‹œê°„ ê¸°ì¤€ âˆ’30ë¶„ ë³´ì •</p>

  <div class="form">
    <div>
      <label>ë…„</label>
      <input id="y" type="number" maxlength="4" oninput="limitDigits(this,4)" autocomplete="off">
    </div>
    <div>
      <label>ì›”</label>
      <input id="m" type="number" maxlength="2" oninput="limitDigits(this,2)" autocomplete="off">
    </div>
    <div>
      <label>ì¼</label>
      <input id="d" type="number" maxlength="2" oninput="limitDigits(this,2)" autocomplete="off">
    </div>
    <div>
      <label>ì‹œ (HH ë˜ëŠ” HHmm)</label>
      <input id="t" type="text" inputmode="numeric" maxlength="4"
             oninput="limitDigits(this,4)" autocomplete="off">
    </div>
  </div>

  <div class="genderBox">
    <label><input type="radio" name="sex" value="m" checked> ë‚¨ì„±</label>
    <label><input type="radio" name="sex" value="f"> ì—¬ì„±</label>
  </div>

  <div class="topbar">
    <button class="btn btn-dark" onclick="go()">ê³„ì‚°í•˜ê¸°</button>
    <button class="btn btn-ghost" onclick="capture()">ğŸ“¸ ìº¡ì²˜</button>
  </div>

  <div id="resultSection" style="display:none">

    <div id="originBox" class="pillars"></div>

    <div class="sectionTitle">ëŒ€ìš´ (10ë…„)</div>
    <div class="railWrap"><div id="decadeRail" class="rail"></div></div>

    <div class="sectionTitle">ì„¸ìš´ (1ë…„)</div>
    <div class="railWrap"><div id="yearRail" class="rail"></div></div>

    <div class="sectionTitle">ì›”ìš´ (1ì›”)</div>
    <div class="railWrap"><div id="monthRail" class="rail"></div></div>

    <!-- ğŸ”¥ GPTê°€ ì½ì„ ìˆ˜ ìˆëŠ” ìˆœìˆ˜ í…ìŠ¤íŠ¸ ì›êµ­ ì˜ì—­ -->
    <div id="pulbawi-gpt-output">
      <p id="gpt-year">ì—°ì£¼: -</p>
      <p id="gpt-month">ì›”ì£¼: -</p>
      <p id="gpt-day">ì¼ì£¼: -</p>
    </div>

  </div> <!-- END resultSection -->

</section>
<script>
/* ===== ì…ë ¥ ìˆ«ì ê¸¸ì´ ì œí•œ ===== */
function limitDigits(el,n){ el.value = el.value.replace(/\D/g,'').slice(0,n); }

/* ===== ìƒìˆ˜/ìœ í‹¸ ===== */
const STEMS_KO=["ê°‘","ì„","ë³‘","ì •","ë¬´","ê¸°","ê²½","ì‹ ","ì„","ê³„"];
const STEMS_HA=["ç”²","ä¹™","ä¸™","ä¸","æˆŠ","å·±","åºš","è¾›","å£¬","ç™¸"];
const BRANCH_KO=["ì","ì¶•","ì¸","ë¬˜","ì§„","ì‚¬","ì˜¤","ë¯¸","ì‹ ","ìœ ","ìˆ ","í•´"];
const BRANCH_HA=["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"];
const MS=86400000;

const elemStem=i=>["ëª©","ëª©","í™”","í™”","í† ","í† ","ê¸ˆ","ê¸ˆ","ìˆ˜","ìˆ˜"][i%10];
const elemBranch=i=>["ìˆ˜","í† ","ëª©","ëª©","í† ","í™”","í™”","í† ","ê¸ˆ","ê¸ˆ","í† ","ìˆ˜"][i%12];
const isYangStem=i=>[1,0,1,0,1,0,1,0,1,0][i%10]===1;
const isYangBranch=i=>[1,0,1,0,1,0,1,0,1,0,1,1][i%12]===1;
const cls=(isStem,i)=>({ëª©:"wood",í™”:"fire",í† :"earth",ê¸ˆ:"metal",ìˆ˜:"water"})[
  isStem?elemStem(i):elemBranch(i)
];
const parseHM=v=>{
  const s=(v||"").replace(/\D/g,"");
  if(!s) return [NaN,NaN];
  return s.length<=2?[+s,0]:[+s.slice(0,2), +s.slice(2,4)||0];
};
const getIsMale=()=>document.querySelector('input[name="sex"]:checked')?.value==="m";

/* ===== í…ìŠ¤íŠ¸ ìˆ˜ì§ ë³´ì • ===== */
function wrapGlyphs(){
  document.querySelectorAll('.g-big').forEach(el=>{
    if(!el.querySelector('.gbtxt')){
      const txt=el.textContent.trim();
      if(!txt) return;
      el.innerHTML='<span class="gbtxt">'+txt+'</span>';
    }
  });
}

/* ===== ì‹­ì„± ===== */
function tenGod(dayElem,isYangDay,otherElem,isYangOther){
  const order=["ëª©","í™”","í† ","ê¸ˆ","ìˆ˜"];
  const di=order.indexOf(dayElem);
  const oi=order.indexOf(otherElem);
  const genTo=(di+1)%5, ctrlTo=(di+2)%5, genFrom=(di+4)%5, ctrlBy=(di+3)%5;
  if(oi===di) return (isYangDay===isYangOther)?"ë¹„ê²¬":"ê²ì¬";
  if(oi===genTo) return (isYangDay===isYangOther)?"ì‹ì‹ ":"ìƒê´€";
  if(oi===ctrlTo) return (isYangDay===isYangOther)?"í¸ì¬":"ì •ì¬";
  if(oi===ctrlBy) return (isYangDay===isYangOther)?"í¸ê´€":"ì •ê´€";
  if(oi===genFrom) return (isYangDay===isYangOther)?"í¸ì¸":"ì •ì¸";
  return "";
}

/* ===== ê°„ì§€ ê³„ì‚° ===== */
function sexagenaryDay(y,m,d){
  const base=new Date(1984,1,2);
  const cur=new Date(y,m-1,d);
  let idx=Math.floor((cur-base)/MS)%60;
  if(idx<0) idx+=60;
  idx=(idx+2)%60;
  return [idx%10, idx%12];
}

function sexagenaryYear(y,m,d){
  const ip=new Date(y,1,4);
  const y2=(new Date(y,m-1,d)<ip)?y-1:y;
  const idx=((y2-1984)%60+60)%60;
  return [idx%10, idx%12];
}

function sexagenaryMonth(y,m,d){
  const marks=[6,4,6,5,5,6,7,7,7,8,7,7];
  const checks=[{ts:new Date(y-1,11,7,9,0,0).getTime(), b:0}];

  for(let mm=1;mm<=12;mm++){
    checks.push({ts:new Date(y,mm-1,marks[mm-1],9,0,0).getTime(), b:mm%12});
  }

  const t=new Date(y,m-1,d,9,0,0).getTime();
  let bIdx=0;
  for(const c of checks) if(t>=c.ts) bIdx=c.b;

  const [yS]=sexagenaryYear(y,m,d);
  const tiger=[2,4,6,8,0,2,4,6,8,0];
  const start=tiger[(yS+10)%10];
  const off=(bIdx-2+12)%12;
  return [(start+off)%10, bIdx];
}

function sexagenaryHour(y,m,d,h,mm=0){
  let base=new Date(y,m-1,d,h,mm);
  base.setMinutes(base.getMinutes()-30);
  let ah=base.getHours(), ay=base.getFullYear(), amn=base.getMonth()+1, ad=base.getDate();
  if(ah===23){ah=0; ad+=1;}
  const [dS]=sexagenaryDay(ay,amn,ad);
  const hb=Math.floor((ah+1)/2)%12;
  const start=[0,2,4,6,8][dS%5];
  return [(start+hb)%10, hb];
}

/* ===== ì ˆì…ì¼ & ëŒ€ìš´ ===== */
function termDate(y,m){
  const day=[6,4,6,5,5,6,7,7,7,8,7,7][m-1];
  return new Date(y,m-1,day,9,0,0);
}

function prevNextTerm(y,m,d,h,mm){
  const birth=new Date(y,m-1,d,h,mm);
  const cur=termDate(y,m);
  let prev,next;
  if(birth<cur){
    prev=(m===1)?termDate(y-1,12):termDate(y,m-1);
    next=cur;
  }else{
    prev=cur;
    next=(m===12)?termDate(y+1,1):termDate(y,m+1);
  }
  return {prev,next,birth};
}

function calcStartAge(y,m,d,h,mm,isMale,yearStemIdx){
  const {prev,next,birth}=prevNextTerm(y,m,d,h,mm);
  const forward=(isMale && isYangStem(yearStemIdx)) || (!isMale && !isYangStem(yearStemIdx));
  const dayMS=1000*60*60*24;
  const diff=forward?(next-birth)/dayMS:(birth-prev)/dayMS;
  const age=Math.round(Math.abs(diff)/3);
  return Math.max(1,Math.min(age,9));
}

/* ===== STATE ===== */
let STATE={y:0,m:0,d:0,h:0,mm:0,isMale:false,dayStem:0,startAge:1,decadeIdx:0,yearVal:null,forward:true};

/* ===== ì›êµ­ ë Œë” ===== */
function renderOrigin(y,m,d,h,mm){
  const [yS,yB]=sexagenaryYear(y,m,d);
  const [mS,mB]=sexagenaryMonth(y,m,d);
  const [dS,dB]=sexagenaryDay(y,m,d);
  const [hS,hB]=sexagenaryHour(y,m,d,h,mm);

  const dayElem=elemStem(dS), isYangDay=isYangStem(dS);

  const items=[
    {title:"ì—°ì£¼",s:yS,b:yB},
    {title:"ì›”ì£¼",s:mS,b:mB},
    {title:"ì¼ì£¼",s:dS,b:dB},
    {title:"ì‹œì£¼",s:hS,b:hB},
  ];

  return items.map(it=>{
    const tgS=(it.title==="ì¼ì£¼")?"ë‚˜(ìì‹ )":tenGod(dayElem,isYangDay,elemStem(it.s),isYangStem(it.s));
    const tgB=tenGod(dayElem,isYangDay,elemBranch(it.b),isYangBranch(it.b));

    return `
      <div class="pillar">
        <h3>${it.title}</h3>
        <div class="gz">
          <div class="g-big ${cls(true,it.s)}">${STEMS_KO[it.s]}(${STEMS_HA[it.s]})</div>
          <div class="g-sip">${tgS}</div>
          <div class="g-big ${cls(false,it.b)}">${BRANCH_KO[it.b]}(${BRANCH_HA[it.b]})</div>
          <div class="g-sip">${tgB}</div>
        </div>
      </div>`;
  }).join("");
}
/* ===== ëŒ€ìš´ ===== */
function buildDecades(){
  const [mS,mB]=sexagenaryMonth(STATE.y,STATE.m,STATE.d);
  const dayElem=elemStem(STATE.dayStem), isYangDay=isYangStem(STATE.dayStem);
  const dir=STATE.forward?1:-1;
  const norm=(v,m)=>((v%m)+m)%m;

  let html="";
  for(let i=0;i<8;i++){
    const s=norm(mS+dir*(i+1),10);
    const b=norm(mB+dir*(i+1),12);
    const cap=STATE.startAge+i*10;
    html+=`
      <div class="tile ${i===STATE.decadeIdx?'active':''}"
           data-type="decade" data-cap="${cap}" data-s="${s}" data-b="${b}">
        <div class="headTop">${cap}</div>
        <div class="g-big ${cls(true,s)}">${STEMS_HA[s]}</div>
        <div class="g-sip">${tenGod(dayElem,isYangDay,elemStem(s),isYangStem(s))}</div>
        <div class="g-big ${cls(false,b)}">${BRANCH_HA[b]}</div>
        <div class="g-sip">${tenGod(dayElem,isYangDay,elemBranch(b),isYangBranch(b))}</div>
      </div>`;
  }

  document.getElementById("decadeRail").innerHTML=html;
  wrapGlyphs();
}

const decadeBaseYear=()=>STATE.y+(STATE.startAge-1)+STATE.decadeIdx*10;

/* ===== ì„¸ìš´ ===== */
function buildYears(){
  const start=decadeBaseYear();
  const dayElem=elemStem(STATE.dayStem), isYangDay=isYangStem(STATE.dayStem);

  let html="";
  for(let i=0;i<10;i++){
    const yr=start+i;
    const [s,b]=sexagenaryYear(yr,1,1);

    html+=`
      <div class="tile ${STATE.yearVal===yr?'active':''}"
           data-type="year" data-cap="${yr}" data-s="${s}" data-b="${b}">
        <div class="headTop">${yr}</div>
        <div class="g-big ${cls(true,s)}">${STEMS_HA[s]}</div>
        <div class="g-sip">${tenGod(dayElem,isYangDay,elemStem(s),isYangStem(s))}</div>
        <div class="g-big ${cls(false,b)}">${BRANCH_HA[b]}</div>
        <div class="g-sip">${tenGod(dayElem,isYangDay,elemBranch(b),isYangBranch(b))}</div>
      </div>`;
  }

  document.getElementById("yearRail").innerHTML=html;
  wrapGlyphs();
}

/* ===== ì›”ìš´ ===== */
function buildMonths(){
  const yr=STATE.yearVal ?? decadeBaseYear();
  const dayElem=elemStem(STATE.dayStem), isYangDay=isYangStem(STATE.dayStem);

  let html="";
  for(let m=1;m<=12;m++){
    const [s,b]=sexagenaryMonth(yr,m,15);

    html+=`
      <div class="tile"
           data-type="month" data-cap="${m}ì›”" data-s="${s}" data-b="${b}">
        <div class="headTop">${m}ì›”</div>
        <div class="g-big ${cls(true,s)}">${STEMS_HA[s]}</div>
        <div class="g-sip">${tenGod(dayElem,isYangDay,elemStem(s),isYangStem(s))}</div>
        <div class="g-big ${cls(false,b)}">${BRANCH_HA[b]}</div>
        <div class="g-sip">${tenGod(dayElem,isYangDay,elemBranch(b),isYangBranch(b))}</div>
      </div>`;
  }

  document.getElementById("monthRail").innerHTML=html;
  wrapGlyphs();
}

/* ===== ë ˆì¼ í´ë¦­ ì—°ë™ ===== */
function bindRails(){
  document.getElementById("decadeRail").onclick=e=>{
    const t=e.target.closest(".tile"); if(!t) return;
    const cap=+t.dataset.cap;
    const idx=Math.floor((cap-STATE.startAge)/10);
    STATE.decadeIdx=Math.max(0,Math.min(7,idx));
    STATE.yearVal=null;
    buildDecades(); buildYears(); buildMonths();
  };

  document.getElementById("yearRail").onclick=e=>{
    const t=e.target.closest(".tile"); if(!t) return;
    STATE.yearVal=+t.dataset.cap;
    buildYears(); buildMonths();
  };

  document.getElementById("monthRail").onclick=e=>{
    const t=e.target.closest(".tile"); if(!t) return;
    document.querySelectorAll("#monthRail .tile").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
  };
}

/* ===== ê³„ì‚° ===== */
window.go=function(){
  const y=+document.getElementById('y').value,
        m=+document.getElementById('m').value,
        d=+document.getElementById('d').value;
  const [hh,mm]=parseHM(document.getElementById('t').value);

  if(!y||!m||!d||isNaN(hh)){
    alert("ë…„/ì›”/ì¼/ì‹œê°„(HH ë˜ëŠ” HHmm)ì„ ì…ë ¥í•˜ì„¸ìš”.");
    return;
  }

  const isMale=getIsMale();
  const [yearStem]=sexagenaryYear(y,m,d);
  const [dayStem]=sexagenaryDay(y,m,d);

  const forward=(isMale && isYangStem(yearStem)) || (!isMale && !isYangStem(yearStem));
  const startAge=calcStartAge(y,m,d,hh,mm,isMale,yearStem);

  STATE={y,m,d,h:hh,mm,isMale,dayStem,startAge,decadeIdx:0,yearVal:null,forward};

  /* ì›êµ­ ê³„ì‚° */
  document.getElementById('resultSection').style.display='block';
  document.getElementById('originBox').innerHTML=renderOrigin(y,m,d,hh,mm);

  buildDecades();
  buildYears();
  buildMonths();
  bindRails();

  /* ğŸ”¥ GPTê°€ ì½ì„ ìˆ˜ ìˆëŠ” ì›êµ­ í…ìŠ¤íŠ¸ ì¶œë ¥ */
  const [YS,YB]=sexagenaryYear(y,m,d);
  const [MS,MB]=sexagenaryMonth(y,m,d);
  const [DS,DB]=sexagenaryDay(y,m,d);

  document.getElementById("gpt-year").innerText =
    "ì—°ì£¼: " + STEMS_KO[YS] + BRANCH_KO[YB] + "ë…„";

  document.getElementById("gpt-month").innerText =
    "ì›”ì£¼: " + STEMS_KO[MS] + BRANCH_KO[MB] + "ì›”";

  document.getElementById("gpt-day").innerText =
    "ì¼ì£¼: " + STEMS_KO[DS] + BRANCH_KO[DB] + "ì¼";
}

/* ===== ìº¡ì²˜ ===== */
window.capture=function(){
  html2canvas(document.getElementById('app'),{
    scale:2,
    backgroundColor:"#fff"
  }).then(cv=>{
    const a=document.createElement('a');
    a.download='pulbawi_saju.png';
    a.href=cv.toDataURL();
    a.click();
  });
};

</script>

</body>
</html>
